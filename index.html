<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Учет зарплат - CIA SOFT</title>
<style>
  :root {
    --bg: #0f1724; 
    --card: #0b1220; 
    --muted: #9aa4b2; 
    --accent: #18a999;
    --accent-light: #2bd4c3;
    --danger: #ff6b6b;
    --danger-light: #ff8e8e;
    --glass: rgba(255,255,255,0.03);
    --glass-light: rgba(255,255,255,0.06);
    --radius: 12px;
    --radius-sm: 8px;
    --transition: all 0.2s ease;
    font-family: Inter, Roboto, system-ui, -apple-system, "Segoe UI", Arial;
  }
  
  html, body {
    height: 100%;
    margin: 0;
    background: linear-gradient(135deg, #071028 0%, #0a1630 100%);
    color: #e6eef6;
    overflow-x: hidden;
  }
  
  .app {
    max-width: 1200px;
    margin: 24px auto;
    padding: 16px;
  }
  
  header {
    display: flex;
    gap: 16px;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--glass-light);
  }
  
  header h1 {
    font-size: 24px;
    margin: 0;
    font-weight: 700;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .controls {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  button, input, select, textarea {
    font: inherit;
    transition: var(--transition);
  }
  
  .card {
    background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    padding: 20px;
    border-radius: var(--radius);
    box-shadow: 0 8px 24px rgba(2,6,23,0.6);
    border: 1px solid var(--glass-light);
    backdrop-filter: blur(10px);
  }
  
  .layout {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 20px;
  }
  
  /* mobile */
  @media (max-width: 768px) { 
    .layout { grid-template-columns: 1fr; } 
    .rightPanel { order: 2; } 
    .app { padding: 12px; }
  }
  
  .form-row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  
  .form-row > * {
    flex: 1 1 160px;
  }
  
  input[type="number"]::-webkit-outer-spin-button, 
  input[type="number"]::-webkit-inner-spin-button { 
    -webkit-appearance: none; 
    margin: 0; 
  }
  
  input[type="password"] {
    letter-spacing: 2px;
    font-family: monospace;
  }
  
  label {
    font-size: 13px;
    color: var(--muted);
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
  }
  
  input[type="text"], input[type="number"], input[type="password"], select, textarea, input[type="date"] {
    width: 100%;
    padding: 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--glass-light);
    background: var(--glass);
    color: inherit;
    outline: none;
    transition: var(--transition);
  }
  
  input[type="text"]:focus, 
  input[type="number"]:focus, 
  input[type="password"]:focus,
  select:focus, 
  textarea:focus, 
  input[type="date"]:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(24, 169, 153, 0.2);
  }
  
  .btn {
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    border: 0;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    color: #021617;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(24, 169, 153, 0.3);
  }
  
  .btn.ghost {
    background: transparent;
    border: 1px solid var(--glass-light);
    color: var(--muted);
  }
  
  .btn.ghost:hover {
    background: var(--glass);
    border-color: var(--accent);
    color: var(--accent);
  }
  
  .btn.warn {
    background: linear-gradient(90deg, var(--danger), var(--danger-light));
    color: #fff;
  }
  
  .btn.warn:hover {
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
  }
  
  .btn.lock {
    background: linear-gradient(90deg, #ff9a5b, #ff6b6b);
    color: #fff;
  }
  
  .points {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  
  .point-pill {
    padding: 10px 14px;
    border-radius: 999px;
    background: var(--glass);
    cursor: pointer;
    border: 1px solid transparent;
    transition: var(--transition);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .point-pill:hover {
    background: rgba(255,255,255,0.05);
    transform: translateY(-2px);
  }
  
  .point-pill.active {
    background: linear-gradient(90deg, rgba(24,169,153,0.15), rgba(15,181,160,0.06));
    border-color: rgba(24,169,153,0.28);
    color: var(--accent-light);
  }
  
  .summary {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  
  .summary .tile {
    flex: 1 1 140px;
    padding: 16px;
    border-radius: var(--radius-sm);
    background: var(--glass);
    text-align: center;
    transition: var(--transition);
  }
  
  .summary .tile:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  }
  
  .tile h3 {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
  }
  
  .tile p {
    margin: 8px 0 0;
    font-size: 20px;
    font-weight: 700;
  }
  
  .entries {
    margin-top: 16px;
    max-height: 400px;
    overflow: auto;
    border-radius: var(--radius-sm);
  }
  
  .entry {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    padding: 14px;
    border-radius: var(--radius-sm);
    margin-bottom: 10px;
    background: var(--glass);
    transition: var(--transition);
    border-left: 3px solid transparent;
  }
  
  .entry:hover {
    background: rgba(255,255,255,0.05);
    transform: translateX(4px);
  }
  
  .entry.salary {
    border-left-color: var(--accent);
  }
  
  .entry.payout {
    border-left-color: var(--danger);
  }
  
  .entry .left {
    flex: 1;
  }
  
  .entry .right {
    min-width: 140px;
    text-align: right;
  }
  
  .entry .amount.income {
    color: var(--accent-light);
    font-weight: 700;
  }
  
  .entry .amount.expense {
    color: var(--danger-light);
    font-weight: 700;
  }
  
  .muted {
    color: var(--muted);
    font-size: 13px;
  }
  
  .tiny {
    font-size: 12px;
    color: var(--muted);
  }
  
  .toolbar {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .search {
    padding: 10px;
    border-radius: var(--radius-sm);
    background: var(--glass);
    border: 1px solid var(--glass-light);
    color: inherit;
    flex: 1;
  }
  
  footer {
    margin-top: 20px;
    text-align: center;
    color: var(--muted);
    font-size: 13px;
    padding-top: 16px;
    border-top: 1px solid var(--glass-light);
  }
  
  a.link {
    color: var(--accent);
    text-decoration: none;
  }
  
  .progress-bar {
    height: 8px;
    background: rgba(255,255,255,0.05);
    border-radius: 4px;
    margin: 12px 0;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    border-radius: 4px;
    transition: width 0.5s ease;
  }
  
  h3, h4 {
    margin-top: 0;
    font-weight: 600;
  }
  
  h3 {
    font-size: 18px;
  }
  
  h4 {
    font-size: 16px;
  }
  
  hr {
    border: 0;
    height: 1px;
    background: var(--glass-light);
    margin: 16px 0;
  }
  
  .section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 16px;
  }
  
  .section-title::before {
    content: "";
    width: 4px;
    height: 16px;
    background: var(--accent);
    border-radius: 2px;
  }
  
  .employee-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    border-radius: var(--radius-sm);
    background: var(--glass);
    margin-bottom: 10px;
    transition: var(--transition);
  }
  
  .employee-card:hover {
    background: rgba(255,255,255,0.05);
    transform: translateX(4px);
  }
  
  .employee-card .info h4 {
    margin: 0 0 4px;
    font-size: 15px;
  }
  
  .employee-card .info .rate {
    font-size: 13px;
    color: var(--muted);
  }
  
  .employee-card .balance {
    text-align: right;
  }
  
  .employee-card .balance .amount {
    font-weight: 700;
    font-size: 16px;
  }
  
  .employee-card .balance .status {
    font-size: 12px;
    color: var(--muted);
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .badge.positive {
    background: rgba(24, 169, 153, 0.15);
    color: var(--accent-light);
  }
  
  .badge.negative {
    background: rgba(255, 107, 107, 0.15);
    color: var(--danger-light);
  }
  
  .badge.category {
    background: rgba(155, 89, 182, 0.15);
    color: #bb86fc;
    font-size: 10px;
  }
  
  .empty-state {
    text-align: center;
    padding: 30px 20px;
    color: var(--muted);
  }
  
  .empty-state .icon {
    font-size: 40px;
    margin-bottom: 10px;
    opacity: 0.5;
  }
  
  .empty-state p {
    margin: 0;
  }
  
  .category-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    background: rgba(155, 89, 182, 0.15);
    color: #bb86fc;
  }
  
  .login-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #071028 0%, #0a1630 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  
  .login-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    padding: 40px;
    border-radius: var(--radius);
    box-shadow: 0 8px 32px rgba(2,6,23,0.8);
    border: 1px solid var(--glass-light);
    backdrop-filter: blur(10px);
    max-width: 400px;
    width: 90%;
    text-align: center;
  }
  
  .login-card h2 {
    margin: 0 0 24px;
    background: linear-gradient(90deg, var(--accent), var(--accent-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 28px;
  }
  
  .login-card p {
    color: var(--muted);
    margin-bottom: 24px;
    line-height: 1.5;
  }
  
  .hidden {
    display: none !important;
  }
  
  .shake {
    animation: shake 0.5s ease-in-out;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }
</style>
</head>
<body>
<!-- Экран входа -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <h2>🔐 Учет зарплат</h2>
    <p>Введите пароль для доступа к системе</p>
    <div style="margin-bottom: 20px;">
      <input type="password" id="passwordInput" placeholder="Введите пароль" style="text-align: center; font-size: 16px;" />
    </div>
    <button id="loginBtn" class="btn" style="width: 100%;">Войти в систему</button>
    <div class="tiny muted" style="margin-top: 16px;">
      По умолчанию пароль: 1234
    </div>
  </div>
</div>

<!-- Основное приложение -->
<div id="appContent" class="app hidden">
  <header>
    <h1>Учет зарплат • CIA SOFT</h1>
    <div class="controls">
      <button id="btnExport" class="btn ghost" title="Экспорт CSV">
        <span>📊</span> Экспорт CSV
      </button>
      <button id="btnBackup" class="btn ghost" title="Экспорт/Импорт JSON">
        <span>💾</span> Backup
      </button>
      <button id="btnLock" class="btn lock" title="Заблокировать систему">
        <span>🔒</span> Выход
      </button>
    </div>
  </header>

  <div class="layout">
    <!-- left: operations -->
    <div>
      <div class="card">
        <div class="section-title">
          <h3>Сотрудники</h3>
        </div>
        
        <div class="form-row">
          <div>
            <label>Имя сотрудника</label>
            <input id="newEmployeeName" type="text" placeholder="Введите имя"/>
          </div>
          <div>
            <label>Категория</label>
            <select id="newEmployeeCategory">
              <option value="waiter">Официант</option>
              <option value="cook">Повар</option>
              <option value="manager">Менеджер</option>
              <option value="cleaner">Уборщик</option>
              <option value="barman">Бармен</option>
              <option value="cashier">Кассир</option>
              <option value="books">Книги</option>
              <option value="mangal">Мангал</option>
              <option value="confectionery">Кондитерская</option>
              <option value="custom">Другая</option>
            </select>
          </div>
          <div>
            <label>Дневная ставка</label>
            <input id="newEmployeeSalary" type="number" placeholder="0.00" step="0.01" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="addEmployee" class="btn" style="width:100%">Добавить</button>
          </div>
        </div>
        
        <div class="points" id="employeesList" aria-live="polite"></div>

        <hr>

        <div class="section-title">
          <h3>Операции</h3>
        </div>
        
        <div class="form-row">
          <div>
            <label>Тип операции</label>
            <select id="opType">
              <option value="salary">Начисление зарплаты</option>
              <option value="payout">Выплата</option>
            </select>
          </div>
          <div>
            <label>Сумма</label>
            <input id="opAmount" type="number" placeholder="0.00" step="0.01" />
          </div>
          <div>
            <label>Дата</label>
            <input id="opDate" type="date" />
          </div>
        </div>

        <div class="form-row">
          <div style="flex:2">
            <label>Описание</label>
            <input id="opNote" type="text" placeholder="комментарий" />
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <button id="addOp" class="btn">Сохранить операцию</button>
          <div style="flex:1;text-align:right" class="tiny muted">Данные сохраняются локально</div>
        </div>
      </div>

      <div style="margin-top:16px" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="section-title">
              <h3>История операций</h3>
            </div>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <select id="filterEmployee"><option value="all">Все сотрудники</option></select>
              <select id="filterCategory"><option value="all">Все категории</option></select>
              <input id="filterFrom" type="date" />
              <input id="filterTo" type="date" />
              <select id="filterType">
                <option value="all">Все операции</option>
                <option value="salary">Начисления</option>
                <option value="payout">Выплаты</option>
              </select>
            </div>
          </div>
          <div style="text-align:right">
            <div class="muted tiny">Текущая задолженность</div>
            <div id="totalBalance" style="font-weight:800;font-size:20px">0.00</div>
          </div>
        </div>

        <div class="entries" id="entriesList" aria-live="polite"></div>
      </div>
    </div>

    <!-- right: summary -->
    <div class="rightPanel">
      <div class="card">
        <div class="section-title">
          <h3>Итоги</h3>
        </div>
        
        <div class="summary" id="summaryTiles">
          <div class="tile"><h3>Начислено</h3><p id="sumAccrued">0</p></div>
          <div class="tile"><h3>Выплачено</h3><p id="sumPaid">0</p></div>
          <div class="tile"><h3>Задолженность</h3><p id="sumDebt">0</p></div>
        </div>

        <hr>

        <h4 style="margin:6px 0">По сотрудникам</h4>
        <div id="employeesSummary" style="display:flex;flex-direction:column;gap:10px"></div>

        <hr>

        <div class="toolbar">
          <button id="btnExportJSON" class="btn ghost">Экспорт JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none"/>
          <button id="btnImportJSON" class="btn">Импорт JSON</button>
          <button id="btnClear" class="btn warn">Сброс данных</button>
        </div>
      </div>

      <div style="height:16px"></div>

      <div class="card">
        <div class="section-title">
          <h3>Автоматическое начисление</h3>
        </div>
        
        <div class="form-row">
          <div>
            <label>Сотрудник</label>
            <select id="autoEmployee"></select>
          </div>
          <div>
            <label>Дней с последней выплаты</label>
            <div id="daysSincePayout" style="text-align:center;padding:12px;font-weight:700;background:var(--glass);border-radius:var(--radius-sm)">0</div>
          </div>
        </div>
        <div class="progress-bar">
          <div id="payoutProgress" class="progress-fill" style="width:0%"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-bottom:12px">
          <span class="tiny muted">0 дней</span>
          <span class="tiny muted">15 дней</span>
        </div>
        <button id="btnAutoSalary" class="btn" style="width:100%">Начислить зарплату за сегодня</button>
        <button id="btnPayout" class="btn warn" style="width:100%;margin-top:10px">Выплатить (обнулить начисления)</button>
      </div>
    </div>
  </div>

  <footer class="muted tiny">Скопируй страницу как файл и открывай локально. Данные не уходят в сеть.</footer>
</div>

<script>
/* Учет зарплат — хранение в localStorage.
   Структура:
   state = { 
     employees: [{id,name,category,dailyRate,lastPayoutDate}], 
     ops: [{id,employeeId,type,amount,date,note,createdAt}] 
   }
*/
(function(){
  const LS_KEY = 'salary_book_v3';
  const PASSWORD_KEY = 'salary_book_password';
  let state = { employees: [], ops: [] };
  let selectedEmployee = null;
  let isAuthenticated = false;

  // Категории сотрудников с иконками и ставками по умолчанию
  const categories = {
    waiter: { name: 'Официант', icon: '🍽️', defaultRate: 1500 },
    cook: { name: 'Повар', icon: '👨‍🍳', defaultRate: 2000 },
    manager: { name: 'Менеджер', icon: '💼', defaultRate: 2500 },
    cleaner: { name: 'Уборщик', icon: '🧹', defaultRate: 1000 },
    barman: { name: 'Бармен', icon: '🍸', defaultRate: 1800 },
    cashier: { name: 'Кассир', icon: '💰', defaultRate: 1700 },
    books: { name: 'Книги', icon: '📚', defaultRate: 1200 },
    mangal: { name: 'Мангал', icon: '🔥', defaultRate: 1900 },
    confectionery: { name: 'Кондитерская', icon: '🍰', defaultRate: 1600 },
    custom: { name: 'Другая', icon: '👤', defaultRate: 1500 }
  };

  // элементы
  const loginScreen = document.getElementById('loginScreen');
  const appContent = document.getElementById('appContent');
  const passwordInput = document.getElementById('passwordInput');
  const loginBtn = document.getElementById('loginBtn');
  const employeesList = document.getElementById('employeesList');
  const addEmployeeBtn = document.getElementById('addEmployee');
  const newEmployeeName = document.getElementById('newEmployeeName');
  const newEmployeeCategory = document.getElementById('newEmployeeCategory');
  const newEmployeeSalary = document.getElementById('newEmployeeSalary');
  const addOpBtn = document.getElementById('addOp');
  const opType = document.getElementById('opType');
  const opAmount = document.getElementById('opAmount');
  const opDate = document.getElementById('opDate');
  const opNote = document.getElementById('opNote');
  const entriesList = document.getElementById('entriesList');
  const sumAccrued = document.getElementById('sumAccrued');
  const sumPaid = document.getElementById('sumPaid');
  const sumDebt = document.getElementById('sumDebt');
  const employeesSummary = document.getElementById('employeesSummary');
  const totalBalance = document.getElementById('totalBalance');
  const filterEmployee = document.getElementById('filterEmployee');
  const filterCategory = document.getElementById('filterCategory');
  const filterFrom = document.getElementById('filterFrom');
  const filterTo = document.getElementById('filterTo');
  const filterType = document.getElementById('filterType');
  const btnExport = document.getElementById('btnExport');
  const btnBackup = document.getElementById('btnBackup');
  const btnLock = document.getElementById('btnLock');
  const btnClear = document.getElementById('btnClear');
  const btnExportJSON = document.getElementById('btnExportJSON');
  const btnImportJSON = document.getElementById('btnImportJSON');
  const importFile = document.getElementById('importFile');
  const autoEmployee = document.getElementById('autoEmployee');
  const daysSincePayout = document.getElementById('daysSincePayout');
  const payoutProgress = document.getElementById('payoutProgress');
  const btnAutoSalary = document.getElementById('btnAutoSalary');
  const btnPayout = document.getElementById('btnPayout');

  // utils
  const uid = (n=8)=> Math.random().toString(36).slice(2,2+n);
  function save(){ 
    if (isAuthenticated) {
      localStorage.setItem(LS_KEY, JSON.stringify(state)); 
      render(); 
    }
  }
  
  function load(){ 
    const raw = localStorage.getItem(LS_KEY); 
    if(raw){ 
      try{ 
        state = JSON.parse(raw); 
      }catch(e){ 
        console.error(e); 
        state={employees:[],ops:[]}; 
      } 
    } 
    if (isAuthenticated) {
      render(); 
    }
  }
  
  function formatMoney(v){ return Number(v).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function clampStr(s, len=40){ return s && s.length>len ? s.slice(0,len-1)+'…' : (s||''); }
  function getDaysBetween(date1, date2) {
    const oneDay = 24 * 60 * 60 * 1000;
    const firstDate = new Date(date1);
    const secondDate = new Date(date2);
    return Math.round(Math.abs((firstDate - secondDate) / oneDay));
  }

  // Система авторизации
  function checkPassword() {
    const savedPassword = localStorage.getItem(PASSWORD_KEY) || '1234';
    return passwordInput.value === savedPassword;
  }

  function login() {
    if (checkPassword()) {
      isAuthenticated = true;
      loginScreen.classList.add('hidden');
      appContent.classList.remove('hidden');
      load();
    } else {
      passwordInput.classList.add('shake');
      setTimeout(() => passwordInput.classList.remove('shake'), 500);
      passwordInput.value = '';
      passwordInput.focus();
    }
  }

  function logout() {
    isAuthenticated = false;
    loginScreen.classList.remove('hidden');
    appContent.classList.add('hidden');
    passwordInput.value = '';
    passwordInput.focus();
  }

  // Обработчики авторизации
  loginBtn.addEventListener('click', login);
  passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') login();
  });
  btnLock.addEventListener('click', logout);

  // init date default = today
  opDate.valueAsDate = new Date();

  // Заполняем категории в селекте
  function populateCategorySelect() {
    newEmployeeCategory.innerHTML = '';
    for (const [key, category] of Object.entries(categories)) {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = `${category.icon} ${category.name}`;
      newEmployeeCategory.appendChild(option);
    }
  }

  // Обновляем ставку при выборе категории
  newEmployeeCategory.addEventListener('change', function() {
    const category = categories[this.value];
    if (category && !newEmployeeSalary.value) {
      newEmployeeSalary.value = category.defaultRate;
    }
  });

  // add employee
  addEmployeeBtn.addEventListener('click', ()=>{
    if (!isAuthenticated) return;
    
    const name = (newEmployeeName.value || '').trim();
    const category = newEmployeeCategory.value;
    let dailyRate = parseFloat(newEmployeeSalary.value);
    
    if(!name) return alert('Введите имя сотрудника');
    if(!category) return alert('Выберите категорию сотрудника');
    if(isNaN(dailyRate) || dailyRate <= 0) {
      // Если ставка не указана, используем ставку по умолчанию для категории
      dailyRate = categories[category].defaultRate;
    }
    
    const id = uid(6);
    state.employees.push({id, name, category, dailyRate, lastPayoutDate: null});
    newEmployeeName.value = '';
    newEmployeeSalary.value = '';
    selectedEmployee = id;
    save();
  });

  // select employee helper
  function selectEmployee(id){
    selectedEmployee = id;
    // highlight pills
    Array.from(employeesList.children).forEach(el=>{
      el.classList.toggle('active', el.dataset.id === id);
    });
    // set filter select to selected employee
    filterEmployee.value = id || 'all';
    // set auto employee select
    autoEmployee.value = id || '';
    updatePayoutProgress();
  }

  // add operation
  addOpBtn.addEventListener('click', ()=>{
    if (!isAuthenticated) return;
    
    const amount = parseFloat(opAmount.value);
    if(isNaN(amount) || amount === 0) return alert('Введите сумму (не 0)');
    if(!selectedEmployee) return alert('Выберите сотрудника (или создайте нового)');
    const t = opType.value;
    const date = opDate.value || new Date().toISOString().slice(0,10);
    const note = (opNote.value||'').trim();
    const id = uid(9);
    state.ops.push({
      id, employeeId: selectedEmployee, type: t, amount: Math.abs(amount),
      date, note, createdAt: new Date().toISOString()
    });
    
    // Если это выплата, обновляем дату последней выплаты
    if (t === 'payout') {
      const employee = state.employees.find(e => e.id === selectedEmployee);
      if (employee) {
        employee.lastPayoutDate = date;
      }
    }
    
    // clear amount and note
    opAmount.value = '';
    opNote.value = '';
    save();
  });

  // render employees list
  function renderEmployees(){
    employeesList.innerHTML = '';
    const frag = document.createDocumentFragment();
    state.employees.forEach(e=>{
      const btn = document.createElement('button');
      btn.className = 'point-pill';
      const category = categories[e.category] || categories.custom;
      btn.innerHTML = `${category.icon} ${e.name} <span class="category-badge">${category.name}</span>`;
      btn.dataset.id = e.id;
      btn.addEventListener('click', ()=> selectEmployee(e.id));
      frag.appendChild(btn);
    });
    employeesList.appendChild(frag);

    // populate filter select
    filterEmployee.innerHTML = '<option value="all">Все сотрудники</option>';
    filterCategory.innerHTML = '<option value="all">Все категории</option>';
    autoEmployee.innerHTML = '<option value="">Выберите сотрудника</option>';
    
    // Добавляем категории в фильтр
    for (const [key, category] of Object.entries(categories)) {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = `${category.icon} ${category.name}`;
      filterCategory.appendChild(option);
    }
    
    // Добавляем сотрудников в фильтры
    for(const e of state.employees){
      const o = document.createElement('option'); 
      o.value = e.id; 
      o.textContent = e.name; 
      filterEmployee.appendChild(o);
      
      const o2 = document.createElement('option'); 
      o2.value = e.id; 
      o2.textContent = e.name; 
      autoEmployee.appendChild(o2);
    }
  }

  // render entries with filters
  function renderEntries(){
    const fEmployee = filterEmployee.value;
    const fCategory = filterCategory.value;
    const from = filterFrom.value;
    const to = filterTo.value;
    const fType = filterType.value;
    
    const filtered = state.ops
      .filter(op=>{
        const employee = state.employees.find(e => e.id === op.employeeId);
        if(!employee) return false;
        
        if(fEmployee !== 'all' && op.employeeId !== fEmployee) return false;
        if(fCategory !== 'all' && employee.category !== fCategory) return false;
        if(from && op.date < from) return false;
        if(to && op.date > to) return false;
        if(fType !== 'all' && op.type !== fType) return false;
        return true;
      })
      .sort((a,b)=> b.date.localeCompare(a.date) || b.createdAt.localeCompare(a.createdAt));

    entriesList.innerHTML = '';
    if(filtered.length === 0){
      entriesList.innerHTML = `
        <div class="empty-state">
          <div class="icon">📋</div>
          <p>Операций нет</p>
        </div>
      `;
      return;
    }
    const frag = document.createDocumentFragment();
    filtered.forEach(op=>{
      const row = document.createElement('div'); 
      row.className = `entry ${op.type}`;
      const left = document.createElement('div'); left.className='left';
      const employee = state.employees.find(e=>e.id===op.employeeId) || {name:'—', category: 'custom'};
      const category = categories[employee.category] || categories.custom;
      
      left.innerHTML = `
        <div style="font-weight:700">${clampStr(op.note || (op.type === 'salary' ? 'Начисление зарплаты' : 'Выплата'), 50)}</div>
        <div class="tiny muted">
          ${category.icon} ${employee.name} 
          <span class="badge category">${category.name}</span>
          • ${op.date}
        </div>`;
      
      const right = document.createElement('div'); right.className='right';
      right.innerHTML = `
        <div class="amount ${op.type === 'salary' ? 'income' : 'expense'}">
          ${op.type==='salary'?'+':'-'} ${formatMoney(op.amount)}
        </div>
        <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:8px">
          <button class="btn ghost" data-id="${op.id}">✎</button>
          <button class="btn warn" data-del="${op.id}">✕</button>
        </div>`;
      row.appendChild(left); row.appendChild(right);
      frag.appendChild(row);
    });
    entriesList.appendChild(frag);

    // attach delete/edit handlers
    entriesList.querySelectorAll('button[data-del]').forEach(b=>{
      b.addEventListener('click', (e)=>{
        if (!isAuthenticated) return;
        const id = e.currentTarget.dataset.del;
        if(!confirm('Удалить операцию?')) return;
        state.ops = state.ops.filter(o=>o.id!==id);
        save();
      });
    });
    entriesList.querySelectorAll('button[data-id]').forEach(b=>{
      b.addEventListener('click', (e)=>{
        if (!isAuthenticated) return;
        const id = e.currentTarget.dataset.id;
        const op = state.ops.find(o=>o.id===id);
        if(!op) return;
        // load into form for quick edit (simple replace)
        selectedEmployee = op.employeeId;
        selectEmployee(op.employeeId);
        opType.value = op.type;
        opAmount.value = op.amount;
        opDate.value = op.date;
        opNote.value = op.note;
        // remove old
        state.ops = state.ops.filter(o=>o.id!==id);
        save();
      });
    });
  }

  // summary calculations
  function renderSummary(){
    let accrued=0, paid=0;
    for(const op of state.ops){
      if(op.type === 'salary') accrued += Number(op.amount);
      else paid += Number(op.amount);
    }
    const debt = accrued - paid;
    sumAccrued.textContent = formatMoney(accrued);
    sumPaid.textContent = formatMoney(paid);
    sumDebt.textContent = formatMoney(debt);
    totalBalance.textContent = formatMoney(debt);

    // per employee
    employeesSummary.innerHTML = '';
    if (state.employees.length === 0) {
      employeesSummary.innerHTML = `
        <div class="empty-state">
          <div class="icon">👥</div>
          <p>Нет сотрудников</p>
        </div>
      `;
      return;
    }
    
    for(const e of state.employees){
      const acc = state.ops.filter(o=>o.employeeId===e.id && o.type==='salary').reduce((s,o)=>s+Number(o.amount),0);
      const pay = state.ops.filter(o=>o.employeeId===e.id && o.type==='payout').reduce((s,o)=>s+Number(o.amount),0);
      const balance = acc - pay;
      const category = categories[e.category] || categories.custom;
      
      const el = document.createElement('div');
      el.className = 'employee-card';
      el.innerHTML = `
        <div class="info">
          <h4>${category.icon} ${e.name}</h4>
          <div class="rate">${category.name} • ${formatMoney(e.dailyRate)}/день</div>
        </div>
        <div class="balance">
          <div class="amount">${formatMoney(balance)}</div>
          <div class="status">
            <span class="badge ${balance >= 0 ? 'positive' : 'negative'}">
              ${balance >= 0 ? 'Долг' : 'Переплата'}
            </span>
          </div>
        </div>
      `;
      
      // Add click to select employee
      el.addEventListener('click', () => selectEmployee(e.id));
      
      employeesSummary.appendChild(el);
    }
  }

  // update payout progress
  function updatePayoutProgress() {
    if (!selectedEmployee) {
      daysSincePayout.textContent = '0';
      payoutProgress.style.width = '0%';
      return;
    }
    
    const employee = state.employees.find(e => e.id === selectedEmployee);
    if (!employee) return;
    
    const lastPayout = employee.lastPayoutDate;
    const today = new Date().toISOString().slice(0,10);
    
    let days = 0;
    if (lastPayout) {
      days = getDaysBetween(lastPayout, today);
    } else {
      // Если выплат не было, считаем с первой операции начисления
      const firstSalaryOp = state.ops
        .filter(o => o.employeeId === selectedEmployee && o.type === 'salary')
        .sort((a, b) => a.date.localeCompare(b.date))[0];
      
      if (firstSalaryOp) {
        days = getDaysBetween(firstSalaryOp.date, today);
      } else {
        days = 0;
      }
    }
    
    daysSincePayout.textContent = days;
    const progress = Math.min(days / 15 * 100, 100);
    payoutProgress.style.width = `${progress}%`;
  }

  // auto salary calculation
  btnAutoSalary.addEventListener('click', () => {
    if (!isAuthenticated) return;
    if (!selectedEmployee) return alert('Выберите сотрудника');
    
    const employee = state.employees.find(e => e.id === selectedEmployee);
    if (!employee) return;
    
    const today = new Date().toISOString().slice(0,10);
    
    // Проверяем, не начисляли ли уже сегодня
    const todaySalary = state.ops.find(o => 
      o.employeeId === selectedEmployee && 
      o.type === 'salary' && 
      o.date === today
    );
    
    if (todaySalary) {
      if (!confirm('Зарплата за сегодня уже начислена. Начислить снова?')) return;
    }
    
    const id = uid(9);
    state.ops.push({
      id, 
      employeeId: selectedEmployee, 
      type: 'salary', 
      amount: employee.dailyRate,
      date: today, 
      note: 'Ежедневное начисление', 
      createdAt: new Date().toISOString()
    });
    
    save();
    alert(`Начислено ${formatMoney(employee.dailyRate)} для ${employee.name}`);
  });

  // payout (reset accumulation)
  btnPayout.addEventListener('click', () => {
    if (!isAuthenticated) return;
    if (!selectedEmployee) return alert('Выберите сотрудника');
    
    const employee = state.employees.find(e => e.id === selectedEmployee);
    if (!employee) return;
    
    // Calculate total accrued but not paid
    const accrued = state.ops
      .filter(o => o.employeeId === selectedEmployee && o.type === 'salary')
      .reduce((sum, o) => sum + Number(o.amount), 0);
      
    const paid = state.ops
      .filter(o => o.employeeId === selectedEmployee && o.type === 'payout')
      .reduce((sum, o) => sum + Number(o.amount), 0);
      
    const debt = accrued - paid;
    
    if (debt <= 0) {
      alert('Нет задолженности для выплаты');
      return;
    }
    
    const today = new Date().toISOString().slice(0,10);
    
    if (!confirm(`Выплатить ${formatMoney(debt)} для ${employee.name}?`)) return;
    
    const id = uid(9);
    state.ops.push({
      id, 
      employeeId: selectedEmployee, 
      type: 'payout', 
      amount: debt,
      date: today, 
      note: 'Выплата зарплаты', 
      createdAt: new Date().toISOString()
    });
    
    // Update last payout date
    employee.lastPayoutDate = today;
    
    save();
    alert(`Выплачено ${formatMoney(debt)} для ${employee.name}`);
  });

  // main render
  function render(){
    if (!isAuthenticated) return;
    
    renderEmployees();
    renderEntries();
    renderSummary();
    updatePayoutProgress();
    // highlight selected
    if(selectedEmployee) selectEmployee(selectedEmployee);
  }

  // filters events
  [filterEmployee, filterCategory, filterFrom, filterTo, filterType].forEach(el=>{
    el.addEventListener('input', ()=> renderEntries());
  });

  // export CSV
  btnExport.addEventListener('click', ()=>{
    if (!isAuthenticated) return;
    
    // build CSV header
    const rows = [['id','employee','category','type','amount','date','note','createdAt']];
    for(const o of state.ops){
      const e = state.employees.find(x=>x.id===o.employeeId) || {name:'', category:''};
      const category = categories[e.category] || categories.custom;
      rows.push([o.id, e.name, category.name, o.type, o.amount, o.date, o.note, o.createdAt]);
    }
    const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'salary_book.csv'; a.click();
    URL.revokeObjectURL(url);
  });

  // export/import JSON
  btnExportJSON.addEventListener('click', ()=>{
    if (!isAuthenticated) return;
    
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'salary_book_backup.json'; a.click();
    URL.revokeObjectURL(url);
  });
  btnImportJSON.addEventListener('click', ()=> {
    if (!isAuthenticated) return;
    importFile.click();
  });
  importFile.addEventListener('change', (e)=>{
    if (!isAuthenticated) return;
    
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = function(){ try{
      const parsed = JSON.parse(reader.result);
      if(!parsed || !Array.isArray(parsed.employees) || !Array.isArray(parsed.ops)) throw new Error('Неверный формат');
      if(!confirm('Импорт заменит текущие данные. Продолжить?')) return;
      state = parsed; save();
      alert('Импорт выполнен');
    }catch(err){ alert('Ошибка импорта: ' + err.message) } }
    reader.readAsText(f);
    importFile.value = '';
  });

  // quick backup button opens export/import UI
  btnBackup.addEventListener('click', ()=> {
    if (!isAuthenticated) return;
    
    if(confirm('Экспортировать (OK) или импортировать (Отмена)?')) btnExportJSON.click();
    else btnImportJSON.click();
  });

  // clear all
  btnClear.addEventListener('click', ()=>{
    if (!isAuthenticated) return;
    
    if(!confirm('Полностью удалить всех сотрудников и операции?')) return;
    state = {employees:[], ops:[]};
    selectedEmployee = null;
    save();
  });

  // auto employee change
  autoEmployee.addEventListener('change', () => {
    if (autoEmployee.value) {
      selectEmployee(autoEmployee.value);
    }
  });

  // Инициализация при загрузке
  populateCategorySelect();
  passwordInput.focus();
})();
</script>
</body>
</html>
