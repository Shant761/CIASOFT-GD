<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CIA SOFT - –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
  <style>
    :root {
      --bg: #f8fafc; --card: #ffffff; --accent: #4f46e5; --accent-light: #6366f1;
      --muted: #64748b; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
      --border: #e2e8f0; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: #0f172a; min-height: 100vh; line-height: 1.5; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 20px; background: var(--card); border-radius: 12px; box-shadow: var(--shadow); }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon { width: 36px; height: 36px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
    h1 { font-size: 20px; font-weight: 700; }
    .subtitle { font-size: 13px; color: var(--muted); }
    .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; }
    .grid { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
    .section-title { font-weight: 600; margin-bottom: 15px; display: flex; align-items: center; gap: 6px; }
    .controls { display: flex; gap: 10px; }
    label { font-size: 13px; color: var(--muted); font-weight: 500; margin-bottom: 5px; display: block; }
    input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 14px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    th { font-size: 13px; color: var(--muted); font-weight: 500; }
    td[contenteditable] { background: #fbfdff; border-radius: 4px; }
    button { background: var(--accent); color: #fff; padding: 8px 14px; border-radius: 8px; border: 0; cursor: pointer; font-weight: 500; font-size: 13px; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
    button:hover { background: var(--accent-light); }
    button.ghost { background: transparent; color: var(--accent); border: 1px solid var(--border); }
    button.warn { background: var(--danger); }
    .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .small-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: var(--shadow); }
    .small-card.payroll { border-top: 3px solid var(--accent); }
    .small-card.expenses { border-top: 3px solid var(--warning); }
    .small-card.income { border-top: 3px solid #8b5cf6; }
    .small-card.profit { border-top: 3px solid var(--success); }
    .k { font-size: 18px; font-weight: 700; margin-top: 5px; }
    .history-panel { position: fixed; top:0; right:-350px; width:350px; height:100%; background: white; box-shadow: var(--shadow); z-index: 999; transition: right 0.3s; padding: 20px; overflow-y: auto; }
    .history-panel.open { right: 0; }
    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 998; display: none; }
    .overlay.active { display: block; }
    .tabs { display: flex; gap: 4px; margin-bottom: 15px; background: #f1f5f9; padding: 4px; border-radius: 8px; width: fit-content; }
    .tab { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
    .tab.active { background: white; box-shadow: var(--shadow); }
    .firebase-section { background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px dashed #7dd3fc; margin-top: 15px; }
    .auth-status { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-weight: 500; }
    .auth-status.connected { color: var(--success); }
    .auth-status.disconnected { color: var(--muted); }
    .user-info { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
    .setup-guide { background: #fff7ed; border: 1px solid #fdba74; border-radius: 8px; padding: 12px; margin-top: 10px; font-size: 12px; }
    .setup-guide h4 { margin: 0 0 8px 0; color: #ea580c; }
    .setup-guide ol { margin: 0; padding-left: 16px; }
    .setup-guide li { margin-bottom: 4px; }
    @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { 
      .container { padding: 15px; } 
      header { flex-direction: column; gap: 15px; align-items: flex-start; }
      .controls { width: 100%; justify-content: center; }
      .summary { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>
  <div class="history-panel" id="historyPanel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
      <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –æ—Ç—á—ë—Ç–æ–≤</div>
      <button id="closeHistory" class="ghost">‚úñ</button>
    </div>
    <div id="historyList"></div>
  </div>

  <div class="container" id="appContainer">
    <header>
      <div class="logo">
        <div class="logo-icon">CIA</div>
        <div>
          <h1>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç</h1>
          <div class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
        </div>
      </div>
      <div class="controls">
        <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="historyBtn" class="ghost">üìä –ò—Å—Ç–æ—Ä–∏—è</button>
        <button id="exportCsv" class="ghost">üìÑ –≠–∫—Å–ø–æ—Ä—Ç</button>
      </div>
    </header>

    <div class="grid">
      <main>
        <div class="card">
          <div class="tabs">
            <div class="tab active" data-tab="period">–ü–µ—Ä–∏–æ–¥</div>
            <div class="tab" data-tab="payroll">–ó–∞—Ä–ø–ª–∞—Ç—ã</div>
            <div class="tab" data-tab="expenses">–†–∞—Å—Ö–æ–¥—ã</div>
            <div class="tab" data-tab="income">–î–æ—Ö–æ–¥—ã</div>
          </div>

          <div class="tab-content active" id="period-tab">
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 250px;">
                <div class="section-title">–ü–µ—Ä–∏–æ–¥ –æ—Ç—á—ë—Ç–∞</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <div style="flex: 1;">
                    <label>–ù–∞—á–∞–ª–æ</label>
                    <input type="date" id="periodStart">
                  </div>
                  <div>‚Äî</div>
                  <div style="flex: 1;">
                    <label>–ö–æ–Ω–µ—Ü</label>
                    <input type="date" id="periodEnd">
                  </div>
                </div>
              </div>
              <div style="width: 200px;">
                <div class="section-title">–í—ã—Ä—É—á–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                <input type="number" id="revenue" step="0.01" placeholder="0.00">
              </div>
            </div>
          </div>

          <div class="tab-content" id="payroll-tab">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div class="section-title">–ó–∞—Ä–ø–ª–∞—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</div>
              <div>
                <button id="addPayroll">+ –î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
            <table id="payrollTable">
              <thead><tr><th>–ò–º—è</th><th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th><th>–°—É–º–º–∞</th><th width="40"></th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><th colspan="2">–ò—Ç–æ–≥–æ</th><th id="payrollTotal">0.00</th><th></th></tr></tfoot>
            </table>
          </div>

          <div class="tab-content" id="expenses-tab">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div class="section-title">–†–∞—Å—Ö–æ–¥—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
              <div>
                <button id="addExpense">+ –î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
            <table id="expensesTable">
              <thead><tr><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th><th>–°—É–º–º–∞</th><th width="40"></th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><th colspan="2">–ò—Ç–æ–≥–æ</th><th id="expensesTotal">0.00</th><th></th></tr></tfoot>
            </table>
          </div>

          <div class="tab-content" id="income-tab">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <div class="section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ—Ö–æ–¥—ã</div>
              <div>
                <button id="addIncome">+ –î–æ–±–∞–≤–∏—Ç—å</button>
              </div>
            </div>
            <table id="incomeTable">
              <thead><tr><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th width="40"></th></tr></thead>
              <tbody></tbody>
              <tfoot><tr><th colspan="2">–ò—Ç–æ–≥–æ</th><th id="incomeTotal">0.00</th><th></th></tr></tfoot>
            </table>
          </div>
        </div>
      </main>

      <aside>
        <div class="card">
          <div class="section-title">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</div>
          <div class="summary">
            <div class="small-card payroll">
              <div style="font-size: 13px; color: var(--muted);">–ó–∞—Ä–ø–ª–∞—Ç—ã</div>
              <div class="k" id="sumPayroll">0.00</div>
            </div>
            <div class="small-card expenses">
              <div style="font-size: 13px; color: var(--muted);">–†–∞—Å—Ö–æ–¥—ã</div>
              <div class="k" id="sumExpenses">0.00</div>
            </div>
            <div class="small-card income">
              <div style="font-size: 13px; color: var(--muted);">–î–æ—Ö–æ–¥—ã</div>
              <div class="k" id="sumIncome">0.00</div>
            </div>
            <div class="small-card profit">
              <div style="font-size: 13px; color: var(--muted);">–ü—Ä–∏–±—ã–ª—å</div>
              <div class="k" id="profit">0.00</div>
            </div>
          </div>

          <div class="firebase-section">
            <div class="section-title" style="font-size: 16px; margin-bottom: 12px;">Firebase –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</div>
            
            <div id="firebaseStatus" class="auth-status disconnected">
              üî¥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
            </div>
            
            <div id="userInfo" style="display: none;">
              <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                  <div id="userEmail" style="font-weight: 500;"></div>
                  <div style="font-size: 12px; color: var(--muted);" id="userId"></div>
                </div>
              </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
              <button id="firebaseLogin" class="ghost">–í–æ–π—Ç–∏ –≤ Firebase</button>
              <button id="firebaseRegister" class="ghost">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
              <button id="firebaseLogout" class="ghost" style="display: none;">–í—ã–π—Ç–∏</button>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button id="syncToFirebase" class="ghost">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
              <button id="loadFromFirebase" class="ghost">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
            </div>

            <div class="setup-guide" id="setupGuide">
              <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firebase:</h4>
              <ol>
                <li>–í Firebase Console –≤–∫–ª—é—á–∏—Ç–µ Authentication ‚Üí Email/Password</li>
                <li>–°–æ–∑–¥–∞–π—Ç–µ Firestore Database –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ</li>
                <li>–ù–∞–∂–º–∏—Ç–µ "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</li>
              </ol>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</div>
          <textarea id="reportNote" rows="4" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏..."></textarea>
        </div>

        <div class="card">
          <div class="section-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
          <div style="display: flex; gap: 10px;">
            <button id="zeroAll" class="ghost">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
            <button id="loadSample" class="ghost">üìã –ü—Ä–∏–º–µ—Ä</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
// Firebase config - –ü–û–õ–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
const firebaseConfig = {
  apiKey: "AIzaSyAzKU_mZSVJc6nJA1PTZcKuZ9e8SwuZKqU",
  authDomain: "georges-1c626.firebaseapp.com",
  databaseURL: "https://georges-1c626-default-rtdb.firebaseio.com",
  projectId: "georges-1c626",
  storageBucket: "georges-1c626.firebasestorage.app",
  messagingSenderId: "490623110927",
  appId: "1:490623110927:web:48780c508f49b73497387a",
  measurementId: "G-N20JTJMKSL"
};

// Initialize Firebase
try {
  firebase.initializeApp(firebaseConfig);
  console.log("Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ");
} catch (error) {
  console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", error);
}

const auth = firebase.auth();
const db = firebase.firestore();
// Initialize Analytics
const analytics = firebase.analytics();

// Utils
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const money = v => Number(v || 0).toFixed(2);

// Elements
const historyBtn = $('#historyBtn');
const historyPanel = $('#historyPanel');
const overlay = $('#overlay');
const closeHistory = $('#closeHistory');
const historyList = $('#historyList');

// Firebase elements
const firebaseStatus = $('#firebaseStatus');
const userInfo = $('#userInfo');
const userAvatar = $('#userAvatar');
const userEmail = $('#userEmail');
const userId = $('#userId');
const firebaseLogin = $('#firebaseLogin');
const firebaseRegister = $('#firebaseRegister');
const firebaseLogout = $('#firebaseLogout');
const syncToFirebase = $('#syncToFirebase');
const loadFromFirebase = $('#loadFromFirebase');
const setupGuide = $('#setupGuide');

const payrollTable = $('#payrollTable tbody');
const expensesTable = $('#expensesTable tbody');
const incomeTable = $('#incomeTable tbody');
const payrollTotalEl = $('#payrollTotal');
const expensesTotalEl = $('#expensesTotal');
const incomeTotalEl = $('#incomeTotal');
const sumPayroll = $('#sumPayroll');
const sumExpenses = $('#sumExpenses');
const sumIncome = $('#sumIncome');
const profitEl = $('#profit');
const revenueEl = $('#revenue');
const periodStartEl = $('#periodStart');
const periodEndEl = $('#periodEnd');

// State
let state = {
  periodStart: null,
  periodEnd: null,
  revenue: 0,
  payroll: [],
  expenses: [],
  income: [],
  note: '',
  id: null
}

// Firebase state
let firebaseUser = null;
let isFirebaseConnected = false;

// Test Firebase connection
function testFirebaseConnection() {
  firebaseStatus.textContent = "üü° –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...";
  
  // Test if Firebase is properly initialized
  if (!firebase.apps.length) {
    firebaseStatus.textContent = "üî¥ Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω";
    return false;
  }
  
  // Test Firestore connection
  const testDoc = db.collection('test').doc('connection');
  testDoc.set({test: true, timestamp: new Date()})
    .then(() => {
      firebaseStatus.textContent = "üü¢ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω";
      isFirebaseConnected = true;
      // Clean up test document
      testDoc.delete();
    })
    .catch((error) => {
      console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Firebase:", error);
      firebaseStatus.textContent = "üî¥ –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è";
      isFirebaseConnected = false;
    });
  
  return true;
}

// Firebase Authentication
function initFirebaseAuth() {
  auth.onAuthStateChanged((user) => {
    if (user) {
      firebaseUser = user;
      isFirebaseConnected = true;
      updateFirebaseUI(true);
      showToast('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ Firebase');
      // Log login event
      analytics.logEvent('login');
    } else {
      firebaseUser = null;
      updateFirebaseUI(false);
    }
  }, (error) => {
    console.error("–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error);
    firebaseStatus.textContent = "üî¥ –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏";
  });
}

function updateFirebaseUI(isSignedIn) {
  if (isSignedIn) {
    firebaseStatus.textContent = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
    firebaseStatus.className = 'auth-status connected';
    userInfo.style.display = 'block';
    firebaseLogin.style.display = 'none';
    firebaseRegister.style.display = 'none';
    firebaseLogout.style.display = 'block';
    setupGuide.style.display = 'none';
    
    // Update user info
    userEmail.textContent = firebaseUser.email || '–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    userId.textContent = `ID: ${firebaseUser.uid.substring(0, 8)}...`;
    userAvatar.textContent = (firebaseUser.email || 'U').charAt(0).toUpperCase();
  } else {
    firebaseStatus.textContent = 'üî¥ –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
    firebaseStatus.className = 'auth-status disconnected';
    userInfo.style.display = 'none';
    firebaseLogin.style.display = 'block';
    firebaseRegister.style.display = 'block';
    firebaseLogout.style.display = 'none';
    setupGuide.style.display = 'block';
  }
}

function signInWithEmail() {
  const email = prompt('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –≤—Ö–æ–¥–∞:');
  if (!email) return;
  
  const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:');
  if (!password) return;
  
  auth.signInWithEmailAndPassword(email, password)
    .then((userCredential) => {
      showToast('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ Firebase');
    })
    .catch((error) => {
      console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
      let errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
      if (error.code === 'auth/user-not-found') {
        errorMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.';
      } else if (error.code === 'auth/wrong-password') {
        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
      } else {
        errorMessage = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message;
      }
      showToast(errorMessage, 'error');
    });
}

function registerWithEmail() {
  const email = prompt('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:');
  if (!email) return;
  
  const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤):');
  if (!password) return;
  
  if (password.length < 6) {
    showToast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
    return;
  }
  
  auth.createUserWithEmailAndPassword(email, password)
    .then((userCredential) => {
      showToast('–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
      // Log registration event
      analytics.logEvent('sign_up');
    })
    .catch((error) => {
      console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
      let errorMessage = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email';
      } else {
        errorMessage = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message;
      }
      showToast(errorMessage, 'error');
    });
}

function signOut() {
  auth.signOut()
    .then(() => {
      showToast('–í—ã—Ö–æ–¥ –∏–∑ Firebase –≤—ã–ø–æ–ª–Ω–µ–Ω');
    })
    .catch((error) => {
      console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
      showToast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message, 'error');
    });
}

// Firebase Firestore functions
function saveToFirebase() {
  if (!isFirebaseConnected || !firebaseUser) {
    showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ Firebase', 'error');
    return;
  }
  
  const userRef = db.collection('users').doc(firebaseUser.uid);
  const reportsRef = userRef.collection('reports');
  
  // Generate ID if doesn't exist
  if (!state.id) {
    state.id = generateId();
  }
  
  // Add timestamp
  state.updatedAt = new Date().toISOString();
  state.createdAt = state.createdAt || state.updatedAt;
  state.userId = firebaseUser.uid;
  
  reportsRef.doc(state.id).set(state)
    .then(() => {
      showToast('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase');
      // Log save event
      analytics.logEvent('save_to_cloud');
    })
    .catch((error) => {
      console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firebase:', error);
      showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
    });
}

function loadFromFirebase() {
  if (!isFirebaseConnected || !firebaseUser) {
    showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ Firebase', 'error');
    return;
  }
  
  const reportsRef = db.collection('users').doc(firebaseUser.uid).collection('reports');
  
  reportsRef.orderBy('updatedAt', 'desc').limit(10).get()
    .then((querySnapshot) => {
      const reports = {};
      
      if (querySnapshot.empty) {
        showToast('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤ –≤ –æ–±–ª–∞–∫–µ');
        return;
      }
      
      querySnapshot.forEach((doc) => {
        const report = doc.data();
        const dateKey = report.periodStart || new Date().toISOString().split('T')[0];
        
        if (!reports[dateKey]) {
          reports[dateKey] = [];
        }
        
        reports[dateKey].push(report);
      });
      
      // Load the most recent report
      const firstDate = Object.keys(reports)[0];
      state = reports[firstDate][0];
      render();
      showToast('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Firebase');
      // Log load event
      analytics.logEvent('load_from_cloud');
    })
    .catch((error) => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firebase:', error);
      showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message, 'error');
    });
}

// Firebase event listeners
firebaseLogin.addEventListener('click', signInWithEmail);
firebaseRegister.addEventListener('click', registerWithEmail);
firebaseLogout.addEventListener('click', signOut);
syncToFirebase.addEventListener('click', saveToFirebase);
loadFromFirebase.addEventListener('click', loadFromFirebase);

// Initialize Firebase connection
setTimeout(() => {
  testFirebaseConnection();
  initFirebaseAuth();
}, 1000);

// History panel
historyBtn.addEventListener('click', () => {
  historyPanel.classList.add('open');
  overlay.classList.add('active');
  renderHistoryList();
});

closeHistory.addEventListener('click', () => {
  historyPanel.classList.remove('open');
  overlay.classList.remove('active');
});

overlay.addEventListener('click', closeHistory.click.bind(closeHistory));

// Tabs
$$('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.tab').forEach(t => t.classList.remove('active'));
    $$('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    $(`#${tab.dataset.tab}-tab`).classList.add('active');
  });
});

// Generate ID
function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// Save/load
function saveToStorage(){
  if (!state.id) state.id = generateId();
  
  const reports = JSON.parse(localStorage.getItem('cia_soft_reports') || '{}');
  const dateKey = state.periodStart || new Date().toISOString().split('T')[0];
  
  if (!reports[dateKey]) reports[dateKey] = [];
  
  const existingIndex = reports[dateKey].findIndex(r => r.id === state.id);
  if (existingIndex >= 0) {
    reports[dateKey][existingIndex] = state;
  } else {
    reports[dateKey].push(state);
  }
  
  localStorage.setItem('cia_soft_reports', JSON.stringify(reports));
  showToast('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ');
}

function loadFromStorage(){
  return JSON.parse(localStorage.getItem('cia_soft_reports') || '{}');
}

function renderHistoryList() {
  const reports = loadFromStorage();
  historyList.innerHTML = '';
  
  const allReports = [];
  for (const date in reports) {
    reports[date].forEach(report => allReports.push({date, report}));
  }
  
  allReports.sort((a, b) => new Date(b.date) - new Date(a.date));
  
  if (allReports.length === 0) {
    historyList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--muted);">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –æ—Ç—á—ë—Ç–æ–≤</div>';
    return;
  }
  
  allReports.forEach(({date, report}) => {
    const payrollSum = report.payroll.reduce((s, r) => s + (Number(r.amount) || 0), 0);
    const expensesSum = report.expenses.reduce((s, r) => s + (Number(r.amount) || 0), 0);
    const incomeSum = report.income.reduce((s, r) => s + (Number(r.amount) || 0), 0);
    const revenue = Number(report.revenue) || 0;
    const profit = revenue + incomeSum - payrollSum - expensesSum;
    
    const item = document.createElement('div');
    item.className = `history-item ${report.id === state.id ? 'active' : ''}`;
    item.style.cssText = 'padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; cursor: pointer;';
    item.innerHTML = `
      <div style="font-weight: 600; margin-bottom: 5px;">${formatDate(date)}</div>
      <div style="display: flex; justify-content: space-between; font-size: 13px; color: var(--muted);">
        <span>–í—ã—Ä—É—á–∫–∞: ${money(revenue)}</span>
        <span>–ü—Ä–∏–±—ã–ª—å: ${money(profit)}</span>
      </div>
    `;
    item.addEventListener('click', () => {
      state = JSON.parse(JSON.stringify(report));
      render();
      closeHistory.click();
      showToast('–û—Ç—á—ë—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
    });
    historyList.appendChild(item);
  });
}

function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString('ru-RU');
}

function render(){
  if (!state.periodStart) state.periodStart = new Date().toISOString().split('T')[0];
  if (!state.periodEnd) state.periodEnd = new Date().toISOString().split('T')[0];
  
  periodStartEl.value = state.periodStart;
  periodEndEl.value = state.periodEnd;
  revenueEl.value = state.revenue;
  $('#reportNote').value = state.note || '';

  // Render tables
  payrollTable.innerHTML = '';
  state.payroll.forEach((p, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td contenteditable>${p.name}</td>
      <td contenteditable>${p.role}</td>
      <td contenteditable>${money(p.amount)}</td>
      <td><button onclick="state.payroll.splice(${idx},1); render();" class="ghost">‚úñ</button></td>`;
    payrollTable.appendChild(tr);
  });

  expensesTable.innerHTML = '';
  state.expenses.forEach((e, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td contenteditable>${e.category}</td>
      <td contenteditable>${e.vendor}</td>
      <td contenteditable>${money(e.amount)}</td>
      <td><button onclick="state.expenses.splice(${idx},1); render();" class="ghost">‚úñ</button></td>`;
    expensesTable.appendChild(tr);
  });

  incomeTable.innerHTML = '';
  state.income.forEach((i, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td contenteditable>${i.source}</td>
      <td contenteditable>${i.type}</td>
      <td contenteditable>${money(i.amount)}</td>
      <td><button onclick="state.income.splice(${idx},1); render();" class="ghost">‚úñ</button></td>`;
    incomeTable.appendChild(tr);
  });

  updateTotals();
  attachEditableListeners();
}

function updateTotals(){
  const payrollSum = state.payroll.reduce((s,r) => s + (Number(r.amount)||0), 0);
  const expensesSum = state.expenses.reduce((s,r) => s + (Number(r.amount)||0), 0);
  const incomeSum = state.income.reduce((s,r) => s + (Number(r.amount)||0), 0);
  const revenue = Number(state.revenue)||0;
  const profit = revenue + incomeSum - payrollSum - expensesSum;

  payrollTotalEl.textContent = money(payrollSum);
  expensesTotalEl.textContent = money(expensesSum);
  incomeTotalEl.textContent = money(incomeSum);
  sumPayroll.textContent = money(payrollSum);
  sumExpenses.textContent = money(expensesSum);
  sumIncome.textContent = money(incomeSum);
  profitEl.textContent = money(profit);
  profitEl.style.color = profit < 0 ? 'var(--danger)' : profit > 0 ? 'var(--success)' : 'var(--muted)';
}

function attachEditableListeners(){
  // Table cells
  document.addEventListener('input', (e) => {
    if (!e.target.hasAttribute('contenteditable')) return;
    
    const cell = e.target;
    const tr = cell.closest('tr');
    if (!tr) return;
    
    const idx = Array.from(tr.parentElement.children).indexOf(tr);
    if (idx < 0) return;
    
    const cells = tr.querySelectorAll('[contenteditable]');
    
    if (tr.parentElement === payrollTable) {
      state.payroll[idx] = {
        name: cells[0].textContent.trim(),
        role: cells[1].textContent.trim(),
        amount: parseFloat(cells[2].textContent.replace(',','.')) || 0
      };
    } else if (tr.parentElement === expensesTable) {
      state.expenses[idx] = {
        category: cells[0].textContent.trim(),
        vendor: cells[1].textContent.trim(),
        amount: parseFloat(cells[2].textContent.replace(',','.')) || 0
      };
    } else if (tr.parentElement === incomeTable) {
      state.income[idx] = {
        source: cells[0].textContent.trim(),
        type: cells[1].textContent.trim(),
        amount: parseFloat(cells[2].textContent.replace(',','.')) || 0
      };
    }
    
    updateTotals();
  });

  // Note field
  $('#reportNote').addEventListener('input', (e) => {
    state.note = e.target.value;
  });
}

// Actions
$('#addPayroll').onclick = () => {
  state.payroll.push({name: '–ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫', role: '', amount: 0});
  render();
  $('.tab[data-tab="payroll"]').click();
};

$('#addExpense').onclick = () => {
  state.expenses.push({category: '–†–∞—Å—Ö–æ–¥—ã', vendor: '', amount: 0});
  render();
  $('.tab[data-tab="expenses"]').click();
};

$('#addIncome').onclick = () => {
  state.income.push({source: '–î–æ—Ö–æ–¥—ã', type: '', amount: 0});
  render();
  $('.tab[data-tab="income"]').click();
};

$('#zeroAll').onclick = () => {
  if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')) {
    state = {
      periodStart: new Date().toISOString().split('T')[0],
      periodEnd: new Date().toISOString().split('T')[0],
      revenue: 0,
      payroll: [],
      expenses: [],
      income: [],
      note: '',
      id: generateId()
    };
    render();
  }
};

$('#loadSample').onclick = () => {
  state = {
    periodStart: new Date().toISOString().split('T')[0],
    periodEnd: new Date().toISOString().split('T')[0],
    revenue: 125000,
    payroll: [
      {name: '–ò–≤–∞–Ω–æ–≤ –ê.–ü.', role: '–®–µ—Ñ-–ø–æ–≤–∞—Ä', amount: 35000},
      {name: '–ü–µ—Ç—Ä–æ–≤–∞ –ú.–ò.', role: '–û—Ñ–∏—Ü–∏–∞–Ω—Ç', amount: 15000}
    ],
    expenses: [
      {category: '–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏', vendor: '–û–û–û –ü—Ä–æ–¥—É–∫—Ç—ã', amount: 25000},
      {category: '–ê—Ä–µ–Ω–¥–∞', vendor: '–ê–†–ï–ù–î–û–î–ê–¢–ï–õ–¨', amount: 20000}
    ],
    income: [
      {source: '–ö–µ–π—Ç–µ—Ä–∏–Ω–≥', type: '–£—Å–ª—É–≥–∏', amount: 15000}
    ],
    note: '–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö',
    id: generateId()
  };
  render();
};

$('#saveBtn').onclick = () => {
  saveToStorage();
  if (isFirebaseConnected && firebaseUser) {
    saveToFirebase();
  }
};

$('#exportCsv').onclick = () => {
  const rows = [
    ['–ü–µ—Ä–∏–æ–¥', state.periodStart, state.periodEnd],
    [],
    ['–ó–∞—Ä–ø–ª–∞—Ç—ã'],
    ['–ò–º—è', '–î–æ–ª–∂–Ω–æ—Å—Ç—å', '–°—É–º–º–∞'],
    ...state.payroll.map(p => [p.name, p.role, money(p.amount)]),
    [],
    ['–†–∞—Å—Ö–æ–¥—ã'],
    ['–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ü–æ–ª—É—á–∞—Ç–µ–ª—å', '–°—É–º–º–∞'],
    ...state.expenses.map(e => [e.category, e.vendor, money(e.amount)]),
    [],
    ['–î–æ—Ö–æ–¥—ã'],
    ['–ò—Å—Ç–æ—á–Ω–∏–∫', '–¢–∏–ø', '–°—É–º–º–∞'],
    ...state.income.map(i => [i.source, i.type, money(i.amount)]),
    [],
    ['–í—ã—Ä—É—á–∫–∞', money(state.revenue)],
    ['–ò—Ç–æ–≥–æ –∑–∞—Ä–ø–ª–∞—Ç—ã', money(state.payroll.reduce((s,r) => s + (Number(r.amount)||0), 0))],
    ['–ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥—ã', money(state.expenses.reduce((s,r) => s + (Number(r.amount)||0), 0))],
    ['–ò—Ç–æ–≥–æ –¥–æ—Ö–æ–¥—ã', money(state.income.reduce((s,r) => s + (Number(r.amount)||0), 0))],
    ['–ü—Ä–∏–±—ã–ª—å', money((Number(state.revenue)||0) + state.income.reduce((s,r) => s + (Number(r.amount)||0), 0) - state.payroll.reduce((s,r) => s + (Number(r.amount)||0), 0) - state.expenses.reduce((s,r) => s + (Number(r.amount)||0), 0))]
  ];

  const csv = rows.map(r => r.map(cell => `"${String(cell||'')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'report.csv';
  a.click();
  showToast('CSV —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω');
};

// Input sync
periodStartEl.onchange = e => state.periodStart = e.target.value;
periodEndEl.onchange = e => state.periodEnd = e.target.value;
revenueEl.oninput = e => { state.revenue = parseFloat(e.target.value)||0; updateTotals(); };

// Toast
function showToast(msg, type = '') {
  const toast = document.createElement('div');
  toast.style.cssText = `position: fixed; bottom: 20px; right: 20px; background: ${type === 'error' ? 'var(--danger)' : '#0f172a'}; color: white; padding: 10px 15px; border-radius: 8px; z-index: 1000;`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Initial load
const reports = loadFromStorage();
const today = new Date().toISOString().split('T')[0];

if (Object.keys(reports).length > 0 && reports[today] && reports[today].length > 0) {
  state = reports[today][reports[today].length - 1];
} else {
  state.id = generateId();
  state.periodStart = today;
  state.periodEnd = today;
}

render();

// Auto-save
setInterval(() => {
  saveToStorage();
  if (isFirebaseConnected && firebaseUser) {
    saveToFirebase();
  }
}, 20000);
</script>
</body>
</html>