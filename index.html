<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CIA SOFT ‚Äî –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç (Firebase)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg:#f7fafc; --card:#fff; --accent:#4f46e5; --muted:#64748b;
      --success:#10b981; --danger:#ef4444; --border:#e6eef9; --shadow: 0 6px 18px rgba(12,24,50,0.06);
    }
    *{box-sizing:border-box}
    body{font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:#0f172a; margin:0; min-height:100vh}
    .container{max-width:1200px;margin:24px auto;padding:20px}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--card);border-radius:12px;box-shadow:var(--shadow);gap:12px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:40px;height:40px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:18px;margin:0}
    .subtitle{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:8px}
    button{border:0;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;color:var(--accent);border:1px solid var(--border)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:18px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:6px;margin-bottom:12px}
    .tab{padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;background:#f1f5f9}
    .tab.active{background:var(--card);box-shadow:0 4px 10px rgba(15,23,42,0.04)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=date], input[type=number], textarea, select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    td[contenteditable]{background:#fbfdff;border-radius:4px}
    .summary{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .small-card{background:#fff;padding:12px;border-radius:10px;text-align:center;box-shadow:var(--shadow);font-weight:600}
    .history-panel{position:fixed;right:-420px;top:0;width:420px;height:100%;background:#fff;box-shadow:var(--shadow);z-index:999;transition:right .25s;padding:18px;overflow:auto}
    .history-panel.open{right:0}
    .overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);display:none;z-index:998}
    .overlay.active{display:block}
    .auth-status{font-weight:600;margin-bottom:10px}
    .user-info{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .user-avatar{width:36px;height:36;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .muted{color:var(--muted);font-weight:500}
    footer{margin-top:16px;text-align:center;color:var(--muted);font-size:13px}
    
    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
    .auth-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .auth-modal-content {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      max-width: 440px;
      width: 90%;
      text-align: center;
    }
    .auth-modal h2 {
      margin: 0 0 16px 0;
      font-size: 24px;
    }
    .auth-modal p {
      color: var(--muted);
      margin-bottom: 24px;
      line-height: 1.5;
    }
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
    }
    .auth-form input {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
    }
    .auth-modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .auth-modal-buttons button {
      flex: 1;
      padding: 12px;
    }
    .demo-note {
      margin-top: 20px;
      padding: 12px;
      background: #f0f9ff;
      border-radius: 8px;
      font-size: 14px;
      color: var(--muted);
    }
    
    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <div class="auth-modal" id="authModal">
    <div class="auth-modal-content">
      <div class="logo" style="justify-content:center;margin-bottom:16px">
        <div class="logo-icon">CIA</div>
        <div>
          <h1 style="font-size:20px">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç</h1>
        </div>
      </div>
      
      <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
      <p>–î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –æ—Ç—á—ë—Ç–∞–º–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Firebase</p>
      
      <div class="auth-form">
        <input type="email" id="authEmail" placeholder="–í–∞—à email" autocomplete="email">
        <input type="password" id="authPassword" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
      </div>
      
      <div class="auth-modal-buttons">
        <button id="loginBtn">–í–æ–π—Ç–∏</button>
        <button id="registerBtn" class="ghost">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
      
      <div class="demo-note">
        <strong>–î–µ–º–æ-–¥–æ—Å—Ç—É–ø:</strong><br>
        Email: demo@cia-soft.ru<br>
        –ü–∞—Ä–æ–ª—å: demodemo
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <div class="history-panel" id="historyPanel" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700">–ò—Å—Ç–æ—Ä–∏—è –æ—Ç—á—ë—Ç–æ–≤</div>
      <div><button id="closeHistoryBtn" class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
    <div id="historyList" style="display:grid;gap:8px"></div>
  </div>

  <div class="container" id="mainContent" style="display:none">
    <header>
      <div class="logo">
        <div class="logo-icon">CIA</div>
        <div>
          <h1>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á—ë—Ç</h1>
          <div class="subtitle">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Firebase</div>
        </div>
      </div>

      <div class="controls">
        <button id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
        <button id="historyBtn" class="ghost">üìä –ò—Å—Ç–æ—Ä–∏—è</button>
        <button id="exportCsv" class="ghost">üìÑ –≠–∫—Å–ø–æ—Ä—Ç</button>
      </div>
    </header>

    <div class="grid">
      <main>
        <div class="card">
          <div class="tabs" role="tablist">
            <div class="tab active" data-tab="period">–ü–µ—Ä–∏–æ–¥</div>
            <div class="tab" data-tab="payroll">–ó–∞—Ä–ø–ª–∞—Ç—ã</div>
            <div class="tab" data-tab="expenses">–†–∞—Å—Ö–æ–¥—ã</div>
            <div class="tab" data-tab="income">–î–æ—Ö–æ–¥—ã</div>
          </div>

          <section id="period" class="tab-panel">
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <div style="flex:1;min-width:220px">
                <label>–ù–∞—á–∞–ª–æ</label>
                <input type="date" id="periodStart">
              </div>
              <div style="flex:1;min-width:220px">
                <label>–ö–æ–Ω–µ—Ü</label>
                <input type="date" id="periodEnd">
              </div>
              <div style="width:220px">
                <label>–í—ã—Ä—É—á–∫–∞</label>
                <input type="number" id="revenue" step="0.01" placeholder="0.00">
              </div>
            </div>
          </section>

          <section id="payroll" class="tab-panel" style="display:none;margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">–ó–∞—Ä–ø–ª–∞—Ç—ã</div>
              <div><button id="addPayroll">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
            </div>
            <table aria-label="–¢–∞–±–ª–∏—Ü–∞ –∑–∞—Ä–ø–ª–∞—Ç">
              <thead><tr><th>–ò–º—è</th><th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th><th>–°—É–º–º–∞</th><th></th></tr></thead>
              <tbody id="payrollBody"></tbody>
              <tfoot><tr><th colspan="2">–ò—Ç–æ–≥–æ</th><th id="payrollTotal">0.00</th><th></th></tr></tfoot>
            </table>
          </section>

          <section id="expenses" class="tab-panel" style="display:none;margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">–†–∞—Å—Ö–æ–¥—ã</div>
              <div><button id="addExpense">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
            </div>
            <table aria-label="–¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤">
              <thead><tr><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th><th>–°—É–º–º–∞</th><th></th></tr></thead>
              <tbody id="expensesBody"></tbody>
              <tfoot><tr><th colspan="2">–ò—Ç–æ–≥–æ</th><th id="expensesTotal">0.00</th><th></th></tr></tfoot>
            </table>
          </section>

          <section id="income" class="tab-panel" style="display:none;margin-top:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:700">–î–æ—Ö–æ–¥—ã</div>
              <div><button id="addIncome">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>
            </div>
            <table aria-label="–¢–∞–±–ª–∏—Ü–∞ –¥–æ—Ö–æ–¥–æ–≤">
              <thead><tr><th>–ò—Å—Ç–æ—á–Ω–∏–∫</th><th>–¢–∏–ø</th><th>–°—É–º–º–∞</th><th></th></tr></thead>
              <tbody id="incomeBody"></tbody>
              <tfoot><tr><th colspan="2">–ò—Ç–æ–≥–æ</th><th id="incomeTotal">0.00</th><th></th></tr></tfoot>
            </table>
          </section>
        </div>
      </main>

      <aside>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</div>
            <div id="authControls" style="display:flex;gap:8px">
              <button id="authBtn" class="ghost">–í–æ–π—Ç–∏</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <div id="firebaseStatus" class="auth-status muted">üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
            <div id="userBlock" style="display:none">
              <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                  <div id="userEmail" style="font-weight:700"></div>
                  <div id="userUid" class="muted" style="font-size:13px"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="summary">
            <div class="small-card">
              <div class="muted">–ó–∞—Ä–ø–ª–∞—Ç—ã</div>
              <div id="sumPayroll" style="font-size:18px;margin-top:6px">0.00</div>
            </div>
            <div class="small-card">
              <div class="muted">–†–∞—Å—Ö–æ–¥—ã</div>
              <div id="sumExpenses" style="font-size:18px;margin-top:6px">0.00</div>
            </div>
            <div class="small-card">
              <div class="muted">–î–æ—Ö–æ–¥—ã</div>
              <div id="sumIncome" style="font-size:18px;margin-top:6px">0.00</div>
            </div>
            <div class="small-card">
              <div class="muted">–ü—Ä–∏–±—ã–ª—å</div>
              <div id="sumProfit" style="font-size:18px;margin-top:6px">0.00</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
            <textarea id="reportNote" rows="4" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏..."></textarea>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="clearBtn" class="ghost">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
            <button id="loadHistoryBtn" class="ghost">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
          </div>
        </div>
      </aside>
    </div>

    <footer>¬© CIA SOFT ‚Äî Firebase-only sync</footer>
  </div>

<script>
(() => {
  'use strict';

  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyAzKU_mZSVJc6nJA1PTZcKuZ9e8SwuZKqU",
    authDomain: "georges-1c626.firebaseapp.com",
    databaseURL: "https://georges-1c626-default-rtdb.firebaseio.com",
    projectId: "georges-1c626",
    storageBucket: "georges-1c626.firebasestorage.app",
    messagingSenderId: "490623110927",
    appId: "1:490623110927:web:48780c508f49b73497387a",
    measurementId: "G-N20JTJMKSL"
  };

  // Initialize
  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  } catch (err) {
    console.error('Firebase init error', err);
  }
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ---------- Helpers ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const money = v => Number(v || 0).toFixed(2);
  const nowDate = () => new Date().toISOString().split('T')[0];
  const debounce = (fn, delay=2500) => {
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(()=>fn(...args), delay);
    };
  };

  // ---------- State ----------
  let state = {
    periodStart: nowDate(),
    periodEnd: nowDate(),
    revenue: 0,
    payroll: [],
    expenses: [],
    income: [],
    note: '',
    id: null,
    createdAt: null,
    updatedAt: null,
    userId: null
  };

  let currentUser = null;
  let autoSaveDebounced = null;

  // ---------- DOM ----------
  const elements = {
    // auth modal
    authModal: $('#authModal'),
    authEmail: $('#authEmail'),
    authPassword: $('#authPassword'),
    loginBtn: $('#loginBtn'),
    registerBtn: $('#registerBtn'),
    mainContent: $('#mainContent'),
    
    // tabs
    tabs: $$('.tab'),
    panels: $$('.tab-panel'),
    periodStart: $('#periodStart'),
    periodEnd: $('#periodEnd'),
    revenue: $('#revenue'),
    payrollBody: $('#payrollBody'),
    expensesBody: $('#expensesBody'),
    incomeBody: $('#incomeBody'),
    addPayroll: $('#addPayroll'),
    addExpense: $('#addExpense'),
    addIncome: $('#addIncome'),
    payrollTotal: $('#payrollTotal'),
    expensesTotal: $('#expensesTotal'),
    incomeTotal: $('#incomeTotal'),
    sumPayroll: $('#sumPayroll'),
    sumExpenses: $('#sumExpenses'),
    sumIncome: $('#sumIncome'),
    sumProfit: $('#sumProfit'),
    reportNote: $('#reportNote'),
    saveBtn: $('#saveBtn'),
    exportCsv: $('#exportCsv'),
    clearBtn: $('#clearBtn'),
    loadHistoryBtn: $('#loadHistoryBtn'),
    historyBtn: $('#historyBtn'),
    historyPanel: $('#historyPanel'),
    overlay: $('#overlay'),
    closeHistoryBtn: $('#closeHistoryBtn'),
    historyList: $('#historyList'),
    firebaseStatus: $('#firebaseStatus'),
    authBtn: $('#authBtn'),
    userBlock: $('#userBlock'),
    userEmail: $('#userEmail'),
    userUid: $('#userUid'),
    userAvatar: $('#userAvatar')
  };

  // ---------- UI utilities ----------
  function showToast(msg, type='info') {
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.cssText = `position:fixed;right:20px;bottom:20px;padding:10px 12px;border-radius:8px;color:#fff;z-index:1200;max-width:320px;box-shadow:0 6px 20px rgba(2,6,23,.2)`;
    t.style.background = type === 'error' ? 'var(--danger)' : (type === 'success' ? 'var(--success)' : '#0f172a');
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 3000);
  }

  function setFirebaseStatus(text, ok=false) {
    elements.firebaseStatus.textContent = (ok ? 'üü¢ ' : 'üî¥ ') + text;
    elements.firebaseStatus.style.color = ok ? 'var(--success)' : '';
  }

  // ---------- Auth Modal Functions ----------
  function showMainApp() {
    elements.authModal.style.display = 'none';
    elements.mainContent.style.display = 'block';
  }

  function showAuthModal() {
    elements.authModal.style.display = 'flex';
    elements.mainContent.style.display = 'none';
  }

  async function handleLogin() {
    const email = elements.authEmail.value.trim();
    const password = elements.authPassword.value;
    
    if (!email || !password) {
      showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å', 'error');
      return;
    }
    
    try {
      await auth.signInWithEmailAndPassword(email, password);
      showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
      showMainApp();
    } catch (err) {
      console.error('Login error:', err);
      showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (err.message || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'), 'error');
    }
  }

  async function handleRegister() {
    const email = elements.authEmail.value.trim();
    const password = elements.authPassword.value;
    
    if (!email || !password) {
      showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å', 'error');
      return;
    }
    
    if (password.length < 6) {
      showToast('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
      return;
    }
    
    try {
      await auth.createUserWithEmailAndPassword(email, password);
      showToast('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
      showMainApp();
    } catch (err) {
      console.error('Register error:', err);
      showToast('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (err.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π email'), 'error');
    }
  }

  // Auto-fill demo credentials for testing
  function fillDemoCredentials() {
    elements.authEmail.value = 'demo@cia-soft.ru';
    elements.authPassword.value = 'demodemo';
  }

  // ---------- Rendering ----------
  function renderTables() {
    // payroll
    elements.payrollBody.innerHTML = state.payroll.map((r, idx) => `
      <tr data-type="payroll" data-idx="${idx}">
        <td contenteditable="true" data-field="name">${escapeHtml(r.name||'')}</td>
        <td contenteditable="true" data-field="role">${escapeHtml(r.role||'')}</td>
        <td contenteditable="true" data-field="amount">${money(r.amount)}</td>
        <td><button data-action="delete" data-type="payroll" data-idx="${idx}" class="ghost">‚úñ</button></td>
      </tr>
    `).join('') || '<tr><td colspan="4" class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';

    // expenses
    elements.expensesBody.innerHTML = state.expenses.map((r, idx) => `
      <tr data-type="expenses" data-idx="${idx}">
        <td contenteditable="true" data-field="category">${escapeHtml(r.category||'')}</td>
        <td contenteditable="true" data-field="vendor">${escapeHtml(r.vendor||'')}</td>
        <td contenteditable="true" data-field="amount">${money(r.amount)}</td>
        <td><button data-action="delete" data-type="expenses" data-idx="${idx}" class="ghost">‚úñ</button></td>
      </tr>
    `).join('') || '<tr><td colspan="4" class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';

    // income
    elements.incomeBody.innerHTML = state.income.map((r, idx) => `
      <tr data-type="income" data-idx="${idx}">
        <td contenteditable="true" data-field="source">${escapeHtml(r.source||'')}</td>
        <td contenteditable="true" data-field="type">${escapeHtml(r.type||'')}</td>
        <td contenteditable="true" data-field="amount">${money(r.amount)}</td>
        <td><button data-action="delete" data-type="income" data-idx="${idx}" class="ghost">‚úñ</button></td>
      </tr>
    `).join('') || '<tr><td colspan="4" class="muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';

    updateTotals();
  }

  function updateTotals(){
    const payrollSum = sumArray(state.payroll, 'amount');
    const expensesSum = sumArray(state.expenses, 'amount');
    const incomeSum = sumArray(state.income, 'amount');
    const revenue = Number(state.revenue)||0;
    const profit = revenue + incomeSum - payrollSum - expensesSum;

    elements.payrollTotal.textContent = money(payrollSum);
    elements.expensesTotal.textContent = money(expensesSum);
    elements.incomeTotal.textContent = money(incomeSum);
    elements.sumPayroll.textContent = money(payrollSum);
    elements.sumExpenses.textContent = money(expensesSum);
    elements.sumIncome.textContent = money(incomeSum);
    elements.sumProfit.textContent = money(profit);
    elements.sumProfit.style.color = profit < 0 ? 'var(--danger)' : profit > 0 ? 'var(--success)' : '';
  }

  function sumArray(arr, field) {
    return arr.reduce((s, it) => s + (Number(it[field])||0), 0);
  }

  function escapeHtml(s='') {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // ---------- Events & Delegation ----------
  // Auth modal events
  elements.loginBtn.addEventListener('click', handleLogin);
  elements.registerBtn.addEventListener('click', handleRegister);
  
  // Allow submitting form with Enter key
  elements.authPassword.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleLogin();
  });

  // Tabs
  elements.tabs.forEach(tab => tab.addEventListener('click', () => {
    elements.tabs.forEach(t=>t.classList.remove('active'));
    elements.panels.forEach(p=>p.style.display='none');
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).style.display = 'block';
  }));

  // Add row buttons
  elements.addPayroll.addEventListener('click', () => {
    state.payroll.push({name:'', role:'', amount:0});
    renderTables();
    scheduleAutosave();
  });
  elements.addExpense.addEventListener('click', () => {
    state.expenses.push({category:'', vendor:'', amount:0});
    renderTables();
    scheduleAutosave();
  });
  elements.addIncome.addEventListener('click', () => {
    state.income.push({source:'', type:'', amount:0});
    renderTables();
    scheduleAutosave();
  });

  // Delegated contenteditable & delete buttons
  document.addEventListener('input', (e) => {
    const cell = e.target;
    if (!cell.hasAttribute('contenteditable')) return;
    const tr = cell.closest('tr');
    if (!tr) return;
    const type = tr.dataset.type;
    const idx = Number(tr.dataset.idx);
    const field = cell.dataset.field;
    if (Number.isNaN(idx) || !type || !field) return;

    const val = field === 'amount' ? parseFloat(cell.textContent.replace(',', '.')) || 0 : cell.textContent.trim();
    // update state safely
    if (type === 'payroll' && state.payroll[idx]) state.payroll[idx][field] = val;
    if (type === 'expenses' && state.expenses[idx]) state.expenses[idx][field] = val;
    if (type === 'income' && state.income[idx]) state.income[idx][field] = val;
    updateTotals();
    scheduleAutosave();
  });

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action="delete"]');
    if (!btn) return;
    const type = btn.dataset.type;
    const idx = Number(btn.dataset.idx);
    if (type && !Number.isNaN(idx)) {
      if (type === 'payroll') state.payroll.splice(idx,1);
      if (type === 'expenses') state.expenses.splice(idx,1);
      if (type === 'income') state.income.splice(idx,1);
      renderTables();
      scheduleAutosave();
    }
  });

  // Inputs sync
  elements.periodStart.addEventListener('change', e => { state.periodStart = e.target.value; scheduleAutosave(); });
  elements.periodEnd.addEventListener('change', e => { state.periodEnd = e.target.value; scheduleAutosave(); });
  elements.revenue.addEventListener('input', e => { state.revenue = parseFloat(e.target.value)||0; updateTotals(); scheduleAutosave(); });
  elements.reportNote.addEventListener('input', e => { state.note = e.target.value; scheduleAutosave(); });

  // Clear
  elements.clearBtn.addEventListener('click', () => {
    if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –ø–æ–ª—è –∏ —Ç–∞–±–ª–∏—Ü—ã?')) return;
    state = {
      periodStart: nowDate(),
      periodEnd: nowDate(),
      revenue: 0,
      payroll: [],
      expenses: [],
      income: [],
      note: '',
      id: null,
      createdAt: null,
      updatedAt: null,
      userId: null
    };
    renderAll();
  });

  // Show history panel
  elements.historyBtn.addEventListener('click', openHistoryPanel);
  elements.closeHistoryBtn.addEventListener('click', closeHistoryPanel);
  elements.overlay.addEventListener('click', closeHistoryPanel);

  // Export CSV
  elements.exportCsv.addEventListener('click', () => {
    const rows = [
      ['–ü–µ—Ä–∏–æ–¥', state.periodStart, state.periodEnd],
      [],
      ['–ó–∞—Ä–ø–ª–∞—Ç—ã'],
      ['–ò–º—è','–î–æ–ª–∂–Ω–æ—Å—Ç—å','–°—É–º–º–∞'],
      ...state.payroll.map(p => [p.name||'', p.role||'', money(p.amount)]),
      [],
      ['–†–∞—Å—Ö–æ–¥—ã'],
      ['–ö–∞—Ç–µ–≥–æ—Ä–∏—è','–ü–æ–ª—É—á–∞—Ç–µ–ª—å','–°—É–º–º–∞'],
      ...state.expenses.map(r => [r.category||'', r.vendor||'', money(r.amount)]),
      [],
      ['–î–æ—Ö–æ–¥—ã'],
      ['–ò—Å—Ç–æ—á–Ω–∏–∫','–¢–∏–ø','–°—É–º–º–∞'],
      ...state.income.map(i => [i.source||'', i.type||'', money(i.amount)]),
      [],
      ['–í—ã—Ä—É—á–∫–∞', money(state.revenue)],
      ['–ò—Ç–æ–≥–æ –∑–∞—Ä–ø–ª–∞—Ç—ã', money(sumArray(state.payroll,'amount'))],
      ['–ò—Ç–æ–≥–æ —Ä–∞—Å—Ö–æ–¥—ã', money(sumArray(state.expenses,'amount'))],
      ['–ò—Ç–æ–≥–æ –¥–æ—Ö–æ–¥—ã', money(sumArray(state.income,'amount'))],
      ['–ü—Ä–∏–±—ã–ª—å', money((Number(state.revenue)||0) + sumArray(state.income,'amount') - sumArray(state.payroll,'amount') - sumArray(state.expenses,'amount'))]
    ];
    const csv = rows.map(r => r.map(c => `"${String(c||'')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `report_${state.periodStart || nowDate()}.csv`; a.click();
    showToast('CSV —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
  });

  // Manual save button
  elements.saveBtn.addEventListener('click', async () => {
    try {
      await saveToFirestore();
      showToast('–û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –æ–±–ª–∞–∫–æ', 'success');
    } catch (err) {
      console.error(err);
      showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (err.message || ''), 'error');
    }
  });

  // Load history from Firestore
  elements.loadHistoryBtn.addEventListener('click', fetchHistoryFromFirestore);

  // Auth button (sign in / sign out)
  elements.authBtn.addEventListener('click', async () => {
    if (!currentUser) {
      showAuthModal();
    } else {
      try {
        await auth.signOut();
        showToast('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
      } catch (err) {
        showToast('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + (err.message||''), 'error');
      }
    }
  });

  // ---------- History panel ----------
  function openHistoryPanel(){
    elements.historyPanel.classList.add('open');
    elements.overlay.classList.add('active');
    elements.historyPanel.setAttribute('aria-hidden', 'false');
    // load from firestore
    fetchHistoryFromFirestore();
  }
  function closeHistoryPanel(){
    elements.historyPanel.classList.remove('open');
    elements.overlay.classList.remove('active');
    elements.historyPanel.setAttribute('aria-hidden', 'true');
  }

  async function fetchHistoryFromFirestore(){
    if (!currentUser) {
      showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ Firebase —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é', 'error');
      return;
    }
    try {
      setFirebaseStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...', true);
      const ref = db.collection('users').doc(currentUser.uid).collection('reports').orderBy('updatedAt','desc').limit(50);
      const snap = await ref.get();
      elements.historyList.innerHTML = '';
      if (snap.empty) {
        elements.historyList.innerHTML = `<div class="muted">–ù–µ—Ç –æ—Ç—á—ë—Ç–æ–≤ –≤ –æ–±–ª–∞–∫–µ</div>`;
        return;
      }
      snap.forEach(doc => {
        const r = doc.data();
        const div = document.createElement('div');
        div.style.cssText = 'padding:8px;border:1px solid var(--border);border-radius:8px;cursor:pointer';
        const title = r.periodStart || r.createdAt?.split('T')[0] || '';
        const payrollSum = sumArray(r.payroll||[], 'amount');
        const expensesSum = sumArray(r.expenses||[], 'amount');
        const incomeSum = sumArray(r.income||[], 'amount');
        const revenue = Number(r.revenue)||0;
        const profit = revenue + incomeSum - payrollSum - expensesSum;
        div.innerHTML = `<div style="font-weight:700">${title}</div>
          <div style="font-size:13px;color:var(--muted);display:flex;justify-content:space-between;margin-top:6px">
            <span>–í—ã—Ä—É—á–∫–∞: ${money(revenue)}</span><span>–ü—Ä–∏–±—ã–ª—å: ${money(profit)}</span>
          </div>`;
        div.addEventListener('click', () => {
          // load into state
          state = {
            periodStart: r.periodStart || nowDate(),
            periodEnd: r.periodEnd || nowDate(),
            revenue: Number(r.revenue) || 0,
            payroll: Array.isArray(r.payroll) ? r.payroll : [],
            expenses: Array.isArray(r.expenses) ? r.expenses : [],
            income: Array.isArray(r.income) ? r.income : [],
            note: r.note || '',
            id: r.id || doc.id,
            createdAt: r.createdAt || null,
            updatedAt: r.updatedAt || null,
            userId: currentUser.uid
          };
          renderAll();
          closeHistoryPanel();
          showToast('–û—Ç—á—ë—Ç –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
        });
        elements.historyList.appendChild(div);
      });
      setFirebaseStatus('–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞', true);
    } catch (err) {
      console.error(err);
      setFirebaseStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏', false);
      showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + (err.message||''), 'error');
    }
  }

  // ---------- Firestore save/load ----------
  function generateId(){
    return Date.now().toString(36) + Math.random().toString(36).slice(2,10);
  }

  async function saveToFirestore() {
    if (!currentUser) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ Firebase');
    // prepare record
    if (!state.id) state.id = generateId();
    state.userId = currentUser.uid;
    state.updatedAt = new Date().toISOString();
    state.createdAt = state.createdAt || state.updatedAt;

    // sanitize numeric fields
    state.payroll = (state.payroll||[]).map(r => ({name:r.name||'', role:r.role||'', amount: Number(r.amount)||0}));
    state.expenses = (state.expenses||[]).map(r => ({category:r.category||'', vendor:r.vendor||'', amount: Number(r.amount)||0}));
    state.income = (state.income||[]).map(r => ({source:r.source||'', type:r.type||'', amount: Number(r.amount)||0}));
    state.revenue = Number(state.revenue)||0;

    const userRef = db.collection('users').doc(currentUser.uid);
    const reportsRef = userRef.collection('reports');
    await reportsRef.doc(state.id).set(state, {merge:true});
    return true;
  }

  // Autosave (debounced)
  async function autosaveIfSigned() {
    if (!currentUser) return;
    try {
      await saveToFirestore();
      setFirebaseStatus('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', true);
    } catch (err) {
      console.error('autosave error', err);
      setFirebaseStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', false);
    }
  }
  function scheduleAutosave() {
    if (!autoSaveDebounced) autoSaveDebounced = debounce(autosaveIfSigned, 2500);
    autoSaveDebounced();
  }

  // ---------- Auth state ----------
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      elements.userBlock.style.display = 'block';
      elements.userEmail.textContent = user.email || '–ê–Ω–æ–Ω–∏–º';
      elements.userUid.textContent = `ID: ${user.uid.slice(0,8)}...`;
      elements.userAvatar.textContent = (user.email || 'U').charAt(0).toUpperCase();
      elements.authBtn.textContent = '–í—ã–π—Ç–∏';
      setFirebaseStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', true);
      showMainApp();
    } else {
      elements.userBlock.style.display = 'none';
      elements.authBtn.textContent = '–í–æ–π—Ç–∏';
      setFirebaseStatus('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', false);
      showAuthModal();
    }
  });

  // Test basic Firestore connection
  async function testConnection() {
    try {
      await db.collection('__test__').doc('__ping__').set({ts: new Date().toISOString()});
      setFirebaseStatus('Firebase –¥–æ—Å—Ç—É–ø–µ–Ω', true);
      // cleanup optional
      try { await db.collection('__test__').doc('__ping__').delete(); } catch(e){}
    } catch (err) {
      console.warn('Firestore test failed', err);
      setFirebaseStatus('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Firebase', false);
    }
  }
  testConnection();

  // ---------- Render everything ----------
  function renderAll(){
    elements.periodStart.value = state.periodStart || nowDate();
    elements.periodEnd.value = state.periodEnd || nowDate();
    elements.revenue.value = state.revenue || 0;
    elements.reportNote.value = state.note || '';
    renderTables();
  }

  // ---------- Init ----------
  (function init(){
    // Auto-fill demo credentials for easier testing
    fillDemoCredentials();
    
    // initial render
    renderAll();
    
    // Show auth modal by default (will be hidden if user is already logged in)
    showAuthModal();
  })();

})();
</script>
</body>
</html>